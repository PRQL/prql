---
source: book/tests/snapshot.rs
expression: sql
input_file: book/tests/prql/introduction-0.prql
---
WITH table_1 AS (
  SELECT
    title,
    country,
    salary + COALESCE(tax, 0) + benefits_cost AS gross_cost,
    salary + COALESCE(tax, 0) AS gross_salary
  FROM
    employees
  WHERE
    start_date > DATE '2021-01-01'
)
SELECT
  title,
  country,
  AVG(gross_salary),
  SUM(gross_cost) AS sum_gross_cost,
  CONCAT(title, '_', country) AS id,
  LEFT(country, 2) AS country_code
FROM
  table_1
WHERE
  gross_cost > 0
GROUP BY
  title,
  country
HAVING
  SUM(gross_cost) > 100000
ORDER BY
  sum_gross_cost,
  country DESC
LIMIT
  20
