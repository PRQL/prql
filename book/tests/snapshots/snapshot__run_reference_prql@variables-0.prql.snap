---
source: book/tests/snapshot.rs
expression: sql
input_file: book/tests/prql/examples/variables-0.prql
---
WITH table_1 AS (
  SELECT
    title,
    country,
    salary + payroll_tax + benefits_cost AS gross_cost,
    salary + payroll_tax AS gross_salary,
    salary
  FROM
    employees
  WHERE
    country = 'USA'
)
SELECT
  title,
  country,
  AVG(salary),
  AVG(gross_salary),
  SUM(salary),
  SUM(gross_salary),
  AVG(gross_cost),
  SUM(gross_cost) AS sum_gross_cost,
  COUNT(*) AS ct
FROM
  table_1
WHERE
  gross_cost > 0
GROUP BY
  title,
  country
HAVING
  COUNT(*) > 200
ORDER BY
  sum_gross_cost
LIMIT
  20
