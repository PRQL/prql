---
source: src/compiler.rs
assertion_line: 640
expression: compile(ast)?
---
Query:
  - Pipeline:
      - From: employees
      - Filter:
          - Ident: country
          - Raw: "="
          - String: USA
      - Derive:
          - lvalue: gross_salary
            rvalue:
              Terms:
                - Ident: salary
                - Raw: +
                - Ident: payroll_tax
          - lvalue: gross_cost
            rvalue:
              Terms:
                - Terms:
                    - Ident: salary
                    - Raw: +
                    - Ident: payroll_tax
                - Raw: +
                - Ident: benefits_cost
      - Filter:
          - Terms:
              - Terms:
                  - Ident: salary
                  - Raw: +
                  - Ident: payroll_tax
              - Raw: +
              - Ident: benefits_cost
          - Raw: ">"
          - Raw: "0"
      - Aggregate:
          by:
            - Ident: title
            - Ident: country
          calcs:
            - Terms:
                - SString:
                    - String: AVG(
                    - Expr:
                        Terms:
                          - Ident: salary
                    - String: )
            - Terms:
                - SString:
                    - String: SUM(
                    - Expr:
                        Terms:
                          - Ident: salary
                    - String: )
            - Terms:
                - SString:
                    - String: AVG(
                    - Expr:
                        Terms:
                          - Terms:
                              - Ident: salary
                              - Raw: +
                              - Ident: payroll_tax
                    - String: )
            - Terms:
                - SString:
                    - String: SUM(
                    - Expr:
                        Terms:
                          - Terms:
                              - Ident: salary
                              - Raw: +
                              - Ident: payroll_tax
                    - String: )
            - Terms:
                - SString:
                    - String: AVG(
                    - Expr:
                        Terms:
                          - Terms:
                              - Terms:
                                  - Ident: salary
                                  - Raw: +
                                  - Ident: payroll_tax
                              - Raw: +
                              - Ident: benefits_cost
                    - String: )
          assigns:
            - lvalue: sum_gross_cost
              rvalue:
                Terms:
                  - SString:
                      - String: SUM(
                      - Expr:
                          Terms:
                            - Terms:
                                - Terms:
                                    - Ident: salary
                                    - Raw: +
                                    - Ident: payroll_tax
                                - Raw: +
                                - Ident: benefits_cost
                      - String: )
            - lvalue: count
              rvalue:
                Terms:
                  - SString:
                      - String: COUNT(*)
      - Sort:
          - Terms:
              - SString:
                  - String: SUM(
                  - Expr:
                      Terms:
                        - Terms:
                            - Terms:
                                - Ident: salary
                                - Raw: +
                                - Ident: payroll_tax
                            - Raw: +
                            - Ident: benefits_cost
                  - String: )
      - Filter:
          - Terms:
              - SString:
                  - String: SUM(
                  - Expr:
                      Terms:
                        - Terms:
                            - Terms:
                                - Ident: salary
                                - Raw: +
                                - Ident: payroll_tax
                            - Raw: +
                            - Ident: benefits_cost
                  - String: )
          - Raw: ">"
          - Raw: "200"
      - Take: 20

