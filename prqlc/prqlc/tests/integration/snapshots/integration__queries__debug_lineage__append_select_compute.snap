---
source: prqlc/prqlc/tests/integration/queries.rs
expression: "from invoices\nderive total = case [total < 10 => total * 2, true => total]\nselect { customer_id, invoice_id, total }\ntake 5\nappend (\n  from invoice_items\n  derive unit_price = case [unit_price < 1 => unit_price * 2, true => unit_price]\n  select { invoice_line_id, invoice_id, unit_price }\n  take 5\n)\nselect { a = customer_id * 2, b = math.round 1 (invoice_id * total) }\n"
input_file: prqlc/prqlc/tests/integration/queries/append_select_compute.prql
---
frames:
- - 1:14-74
  - columns:
    - !All
      input_id: 162
      except: []
    - !Single
      name:
      - total
      target_id: 164
      target_name: null
    inputs:
    - id: 162
      name: invoices
      table:
      - default_db
      - invoices
- - 1:75-116
  - columns:
    - !Single
      name:
      - invoices
      - customer_id
      target_id: 177
      target_name: null
    - !Single
      name:
      - invoices
      - invoice_id
      target_id: 178
      target_name: null
    - !Single
      name:
      - total
      target_id: 179
      target_name: null
    inputs:
    - id: 162
      name: invoices
      table:
      - default_db
      - invoices
- - 1:117-123
  - columns:
    - !Single
      name:
      - invoices
      - customer_id
      target_id: 177
      target_name: null
    - !Single
      name:
      - invoices
      - invoice_id
      target_id: 178
      target_name: null
    - !Single
      name:
      - total
      target_id: 179
      target_name: null
    inputs:
    - id: 162
      name: invoices
      table:
      - default_db
      - invoices
- - 1:156-235
  - columns:
    - !All
      input_id: 128
      except: []
    - !Single
      name:
      - unit_price
      target_id: 130
      target_name: null
    inputs:
    - id: 128
      name: invoice_items
      table:
      - default_db
      - invoice_items
- - 1:238-288
  - columns:
    - !Single
      name:
      - invoice_items
      - invoice_line_id
      target_id: 143
      target_name: null
    - !Single
      name:
      - invoice_items
      - invoice_id
      target_id: 144
      target_name: null
    - !Single
      name:
      - unit_price
      target_id: 145
      target_name: null
    inputs:
    - id: 128
      name: invoice_items
      table:
      - default_db
      - invoice_items
- - 1:291-297
  - columns:
    - !Single
      name:
      - invoice_items
      - invoice_line_id
      target_id: 143
      target_name: null
    - !Single
      name:
      - invoice_items
      - invoice_id
      target_id: 144
      target_name: null
    - !Single
      name:
      - unit_price
      target_id: 145
      target_name: null
    inputs:
    - id: 128
      name: invoice_items
      table:
      - default_db
      - invoice_items
- - 1:124-299
  - columns:
    - !Single
      name:
      - invoices
      - customer_id
      target_id: 177
      target_name: null
    - !Single
      name:
      - invoices
      - invoice_id
      target_id: 178
      target_name: null
    - !Single
      name:
      - total
      target_id: 179
      target_name: null
    inputs:
    - id: 162
      name: invoices
      table:
      - default_db
      - invoices
    - id: 128
      name: invoice_items
      table:
      - default_db
      - invoice_items
- - 1:300-369
  - columns:
    - !Single
      name:
      - a
      target_id: 186
      target_name: null
    - !Single
      name:
      - b
      target_id: 190
      target_name: null
    inputs:
    - id: 162
      name: invoices
      table:
      - default_db
      - invoices
    - id: 128
      name: invoice_items
      table:
      - default_db
      - invoice_items
nodes:
- id: 128
  kind: Ident
  span: 1:135-153
  ident: !Ident
  - default_db
  - invoice_items
  parent: 142
- id: 130
  kind: Case
  span: 1:176-235
  alias: unit_price
  targets:
  - 131
  - 135
  - 139
  - 140
  parent: 141
- id: 131
  kind: RqOperator
  span: 1:182-196
  targets:
  - 133
  - 134
- id: 133
  kind: Ident
  span: 1:182-192
  ident: !Ident
  - this
  - invoice_items
  - unit_price
  targets:
  - 128
- id: 134
  kind: Literal
  span: 1:195-196
- id: 135
  kind: RqOperator
  span: 1:200-214
  targets:
  - 137
  - 138
- id: 137
  kind: Ident
  span: 1:200-210
  ident: !Ident
  - this
  - invoice_items
  - unit_price
  targets:
  - 128
- id: 138
  kind: Literal
  span: 1:213-214
- id: 139
  kind: Literal
  span: 1:216-220
- id: 140
  kind: Ident
  span: 1:224-234
  ident: !Ident
  - this
  - invoice_items
  - unit_price
  targets:
  - 128
- id: 141
  kind: Tuple
  span: 1:176-235
  children:
  - 130
  parent: 142
- id: 142
  kind: 'TransformCall: Derive'
  span: 1:156-235
  children:
  - 128
  - 141
  parent: 147
- id: 143
  kind: Ident
  span: 1:247-262
  ident: !Ident
  - this
  - invoice_items
  - invoice_line_id
  targets:
  - 128
  parent: 146
- id: 144
  kind: Ident
  span: 1:264-274
  ident: !Ident
  - this
  - invoice_items
  - invoice_id
  targets:
  - 128
  parent: 146
- id: 145
  kind: Ident
  span: 1:276-286
  ident: !Ident
  - this
  - unit_price
  targets:
  - 130
  parent: 146
- id: 146
  kind: Tuple
  span: 1:245-288
  children:
  - 143
  - 144
  - 145
  parent: 147
- id: 147
  kind: 'TransformCall: Select'
  span: 1:238-288
  children:
  - 142
  - 146
  parent: 149
- id: 149
  kind: 'TransformCall: Take'
  span: 1:291-297
  children:
  - 147
  - 150
  parent: 185
- id: 150
  kind: Literal
  parent: 149
- id: 162
  kind: Ident
  span: 1:0-13
  ident: !Ident
  - default_db
  - invoices
  parent: 176
- id: 164
  kind: Case
  span: 1:29-74
  alias: total
  targets:
  - 165
  - 169
  - 173
  - 174
  parent: 175
- id: 165
  kind: RqOperator
  span: 1:35-45
  targets:
  - 167
  - 168
- id: 167
  kind: Ident
  span: 1:35-40
  ident: !Ident
  - this
  - invoices
  - total
  targets:
  - 162
- id: 168
  kind: Literal
  span: 1:43-45
- id: 169
  kind: RqOperator
  span: 1:49-58
  targets:
  - 171
  - 172
- id: 171
  kind: Ident
  span: 1:49-54
  ident: !Ident
  - this
  - invoices
  - total
  targets:
  - 162
- id: 172
  kind: Literal
  span: 1:57-58
- id: 173
  kind: Literal
  span: 1:60-64
- id: 174
  kind: Ident
  span: 1:68-73
  ident: !Ident
  - this
  - invoices
  - total
  targets:
  - 162
- id: 175
  kind: Tuple
  span: 1:29-74
  children:
  - 164
  parent: 176
- id: 176
  kind: 'TransformCall: Derive'
  span: 1:14-74
  children:
  - 162
  - 175
  parent: 181
- id: 177
  kind: Ident
  span: 1:84-95
  ident: !Ident
  - this
  - invoices
  - customer_id
  targets:
  - 162
  parent: 180
- id: 178
  kind: Ident
  span: 1:97-107
  ident: !Ident
  - this
  - invoices
  - invoice_id
  targets:
  - 162
  parent: 180
- id: 179
  kind: Ident
  span: 1:109-114
  ident: !Ident
  - this
  - total
  targets:
  - 164
  parent: 180
- id: 180
  kind: Tuple
  span: 1:82-116
  children:
  - 177
  - 178
  - 179
  parent: 181
- id: 181
  kind: 'TransformCall: Select'
  span: 1:75-116
  children:
  - 176
  - 180
  parent: 183
- id: 183
  kind: 'TransformCall: Take'
  span: 1:117-123
  children:
  - 181
  - 184
  parent: 185
- id: 184
  kind: Literal
  parent: 183
- id: 185
  kind: 'TransformCall: Append'
  span: 1:124-299
  children:
  - 183
  - 149
  parent: 198
- id: 186
  kind: RqOperator
  span: 1:313-328
  alias: a
  targets:
  - 188
  - 189
  parent: 197
- id: 188
  kind: Ident
  span: 1:313-324
  ident: !Ident
  - this
  - invoices
  - customer_id
  targets:
  - 177
- id: 189
  kind: Literal
  span: 1:327-328
- id: 190
  kind: RqOperator
  span: 1:334-367
  alias: b
  targets:
  - 192
  - 193
  parent: 197
- id: 192
  kind: Literal
  span: 1:345-346
- id: 193
  kind: RqOperator
  span: 1:348-366
  targets:
  - 195
  - 196
- id: 195
  kind: Ident
  span: 1:348-358
  ident: !Ident
  - this
  - invoices
  - invoice_id
  targets:
  - 178
- id: 196
  kind: Ident
  span: 1:361-366
  ident: !Ident
  - this
  - total
  targets:
  - 179
- id: 197
  kind: Tuple
  span: 1:307-369
  children:
  - 186
  - 190
  parent: 198
- id: 198
  kind: 'TransformCall: Select'
  span: 1:300-369
  children:
  - 185
  - 197
ast:
  name: Project
  stmts:
  - VarDef:
      kind: Main
      name: main
      value:
        Pipeline:
          exprs:
          - FuncCall:
              name:
                Ident:
                - from
                span: 1:0-4
              args:
              - Ident:
                - invoices
                span: 1:5-13
            span: 1:0-13
          - FuncCall:
              name:
                Ident:
                - derive
                span: 1:14-20
              args:
              - Case:
                - condition:
                    Binary:
                      left:
                        Ident:
                        - total
                        span: 1:35-40
                      op: Lt
                      right:
                        Literal:
                          Integer: 10
                        span: 1:43-45
                    span: 1:35-45
                  value:
                    Binary:
                      left:
                        Ident:
                        - total
                        span: 1:49-54
                      op: Mul
                      right:
                        Literal:
                          Integer: 2
                        span: 1:57-58
                    span: 1:49-58
                - condition:
                    Literal:
                      Boolean: true
                    span: 1:60-64
                  value:
                    Ident:
                    - total
                    span: 1:68-73
                span: 1:29-74
                alias: total
            span: 1:14-74
          - FuncCall:
              name:
                Ident:
                - select
                span: 1:75-81
              args:
              - Tuple:
                - Ident:
                  - customer_id
                  span: 1:84-95
                - Ident:
                  - invoice_id
                  span: 1:97-107
                - Ident:
                  - total
                  span: 1:109-114
                span: 1:82-116
            span: 1:75-116
          - FuncCall:
              name:
                Ident:
                - take
                span: 1:117-121
              args:
              - Literal:
                  Integer: 5
                span: 1:122-123
            span: 1:117-123
          - FuncCall:
              name:
                Ident:
                - append
                span: 1:124-130
              args:
              - Pipeline:
                  exprs:
                  - FuncCall:
                      name:
                        Ident:
                        - from
                        span: 1:135-139
                      args:
                      - Ident:
                        - invoice_items
                        span: 1:140-153
                    span: 1:135-153
                  - FuncCall:
                      name:
                        Ident:
                        - derive
                        span: 1:156-162
                      args:
                      - Case:
                        - condition:
                            Binary:
                              left:
                                Ident:
                                - unit_price
                                span: 1:182-192
                              op: Lt
                              right:
                                Literal:
                                  Integer: 1
                                span: 1:195-196
                            span: 1:182-196
                          value:
                            Binary:
                              left:
                                Ident:
                                - unit_price
                                span: 1:200-210
                              op: Mul
                              right:
                                Literal:
                                  Integer: 2
                                span: 1:213-214
                            span: 1:200-214
                        - condition:
                            Literal:
                              Boolean: true
                            span: 1:216-220
                          value:
                            Ident:
                            - unit_price
                            span: 1:224-234
                        span: 1:176-235
                        alias: unit_price
                    span: 1:156-235
                  - FuncCall:
                      name:
                        Ident:
                        - select
                        span: 1:238-244
                      args:
                      - Tuple:
                        - Ident:
                          - invoice_line_id
                          span: 1:247-262
                        - Ident:
                          - invoice_id
                          span: 1:264-274
                        - Ident:
                          - unit_price
                          span: 1:276-286
                        span: 1:245-288
                    span: 1:238-288
                  - FuncCall:
                      name:
                        Ident:
                        - take
                        span: 1:291-295
                      args:
                      - Literal:
                          Integer: 5
                        span: 1:296-297
                    span: 1:291-297
                span: 1:135-297
            span: 1:124-299
          - FuncCall:
              name:
                Ident:
                - select
                span: 1:300-306
              args:
              - Tuple:
                - Binary:
                    left:
                      Ident:
                      - customer_id
                      span: 1:313-324
                    op: Mul
                    right:
                      Literal:
                        Integer: 2
                      span: 1:327-328
                  span: 1:313-328
                  alias: a
                - FuncCall:
                    name:
                      Ident:
                      - math
                      - round
                      span: 1:334-344
                    args:
                    - Literal:
                        Integer: 1
                      span: 1:345-346
                    - Binary:
                        left:
                          Ident:
                          - invoice_id
                          span: 1:348-358
                        op: Mul
                        right:
                          Ident:
                          - total
                          span: 1:361-366
                      span: 1:348-366
                  span: 1:334-367
                  alias: b
                span: 1:307-369
            span: 1:300-369
        span: 1:0-369
    span: 1:0-369
