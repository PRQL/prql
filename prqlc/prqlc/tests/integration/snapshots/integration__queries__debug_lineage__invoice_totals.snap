---
source: prqlc/prqlc/tests/integration/queries.rs
expression: "# clickhouse:skip (clickhouse doesn't have lag function)\n\n#! Calculate a number of metrics about the sales of tracks in each city.\nfrom i=invoices\njoin ii=invoice_items (==invoice_id)\nderive {\n    city = i.billing_city,\n    street = i.billing_address,\n}\ngroup {city, street} (\n    derive total = ii.unit_price * ii.quantity\n    aggregate {\n        num_orders = count_distinct i.invoice_id,\n        num_tracks = sum ii.quantity,\n        total_price = sum total,\n    }\n)\ngroup {city} (\n    sort street\n    window expanding:true (\n        derive {running_total_num_tracks = sum num_tracks}\n    )\n)\nsort {city, street}\nderive {num_tracks_last_week = lag 7 num_tracks}\nselect {\n    city,\n    street,\n    num_orders,\n    num_tracks,\n    running_total_num_tracks,\n    num_tracks_last_week\n}\ntake 20\n"
input_file: prqlc/prqlc/tests/integration/queries/invoice_totals.prql
---
frames:
- - 1:147-183
  - columns:
    - !All
      input_id: 138
      except: []
    - !All
      input_id: 135
      except: []
    inputs:
    - id: 138
      name: i
      table:
      - default_db
      - invoices
    - id: 135
      name: ii
      table:
      - default_db
      - invoice_items
- - 1:184-253
  - columns:
    - !All
      input_id: 138
      except: []
    - !All
      input_id: 135
      except: []
    - !Single
      name:
      - city
      target_id: 145
      target_name: null
    - !Single
      name:
      - street
      target_id: 146
      target_name: null
    inputs:
    - id: 138
      name: i
      table:
      - default_db
      - invoices
    - id: 135
      name: ii
      table:
      - default_db
      - invoice_items
- - 1:281-323
  - columns:
    - !All
      input_id: 138
      except: []
    - !All
      input_id: 135
      except: []
    - !Single
      name:
      - total
      target_id: 176
      target_name: null
    inputs:
    - id: 138
      name: i
      table:
      - default_db
      - invoices
    - id: 135
      name: ii
      table:
      - default_db
      - invoice_items
- - 1:328-466
  - columns:
    - !Single
      name:
      - city
      target_id: 149
      target_name: null
    - !Single
      name:
      - street
      target_id: 150
      target_name: null
    - !Single
      name:
      - num_orders
      target_id: 182
      target_name: null
    - !Single
      name:
      - num_tracks
      target_id: 185
      target_name: null
    - !Single
      name:
      - total_price
      target_id: 188
      target_name: null
    inputs:
    - id: 138
      name: i
      table:
      - default_db
      - invoices
    - id: 135
      name: ii
      table:
      - default_db
      - invoice_items
- - 1:536-586
  - columns:
    - !Single
      name:
      - city
      target_id: 195
      target_name: null
    - !Single
      name:
      - street
      target_id: 150
      target_name: null
    - !Single
      name:
      - num_orders
      target_id: 182
      target_name: null
    - !Single
      name:
      - num_tracks
      target_id: 185
      target_name: null
    - !Single
      name:
      - total_price
      target_id: 188
      target_name: null
    - !Single
      name:
      - running_total_num_tracks
      target_id: 241
      target_name: null
    inputs:
    - id: 138
      name: i
      table:
      - default_db
      - invoices
    - id: 135
      name: ii
      table:
      - default_db
      - invoice_items
- - 1:595-614
  - columns:
    - !Single
      name:
      - city
      target_id: 195
      target_name: null
    - !Single
      name:
      - street
      target_id: 150
      target_name: null
    - !Single
      name:
      - num_orders
      target_id: 182
      target_name: null
    - !Single
      name:
      - num_tracks
      target_id: 185
      target_name: null
    - !Single
      name:
      - total_price
      target_id: 188
      target_name: null
    - !Single
      name:
      - running_total_num_tracks
      target_id: 241
      target_name: null
    inputs:
    - id: 138
      name: i
      table:
      - default_db
      - invoices
    - id: 135
      name: ii
      table:
      - default_db
      - invoice_items
- - 1:615-663
  - columns:
    - !Single
      name:
      - city
      target_id: 195
      target_name: null
    - !Single
      name:
      - street
      target_id: 150
      target_name: null
    - !Single
      name:
      - num_orders
      target_id: 182
      target_name: null
    - !Single
      name:
      - num_tracks
      target_id: 185
      target_name: null
    - !Single
      name:
      - total_price
      target_id: 188
      target_name: null
    - !Single
      name:
      - running_total_num_tracks
      target_id: 241
      target_name: null
    - !Single
      name:
      - num_tracks_last_week
      target_id: 255
      target_name: null
    inputs:
    - id: 138
      name: i
      table:
      - default_db
      - invoices
    - id: 135
      name: ii
      table:
      - default_db
      - invoice_items
- - 1:664-783
  - columns:
    - !Single
      name:
      - city
      target_id: 261
      target_name: null
    - !Single
      name:
      - street
      target_id: 262
      target_name: null
    - !Single
      name:
      - num_orders
      target_id: 263
      target_name: null
    - !Single
      name:
      - num_tracks
      target_id: 264
      target_name: null
    - !Single
      name:
      - running_total_num_tracks
      target_id: 265
      target_name: null
    - !Single
      name:
      - num_tracks_last_week
      target_id: 266
      target_name: null
    inputs:
    - id: 138
      name: i
      table:
      - default_db
      - invoices
    - id: 135
      name: ii
      table:
      - default_db
      - invoice_items
- - 1:784-791
  - columns:
    - !Single
      name:
      - city
      target_id: 261
      target_name: null
    - !Single
      name:
      - street
      target_id: 262
      target_name: null
    - !Single
      name:
      - num_orders
      target_id: 263
      target_name: null
    - !Single
      name:
      - num_tracks
      target_id: 264
      target_name: null
    - !Single
      name:
      - running_total_num_tracks
      target_id: 265
      target_name: null
    - !Single
      name:
      - num_tracks_last_week
      target_id: 266
      target_name: null
    inputs:
    - id: 138
      name: i
      table:
      - default_db
      - invoices
    - id: 135
      name: ii
      table:
      - default_db
      - invoice_items
nodes:
- id: 135
  kind: Ident
  span: 1:155-168
  ident: !Ident
  - default_db
  - invoice_items
  parent: 144
- id: 138
  kind: Ident
  span: 1:131-146
  ident: !Ident
  - default_db
  - invoices
  parent: 144
- id: 140
  kind: RqOperator
  span: 1:170-182
  targets:
  - 142
  - 143
  parent: 144
- id: 142
  kind: Ident
  span: 1:172-182
  ident: !Ident
  - this
  - i
  - invoice_id
  targets:
  - 138
- id: 143
  kind: Ident
  span: 1:172-182
  ident: !Ident
  - that
  - ii
  - invoice_id
  targets:
  - 135
- id: 144
  kind: 'TransformCall: Join'
  span: 1:147-183
  children:
  - 138
  - 135
  - 140
  parent: 148
- id: 145
  kind: Ident
  span: 1:204-218
  alias: city
  ident: !Ident
  - this
  - i
  - billing_city
  targets:
  - 138
  parent: 147
- id: 146
  kind: Ident
  span: 1:233-250
  alias: street
  ident: !Ident
  - this
  - i
  - billing_address
  targets:
  - 138
  parent: 147
- id: 147
  kind: Tuple
  span: 1:191-253
  children:
  - 145
  - 146
  parent: 148
- id: 148
  kind: 'TransformCall: Derive'
  span: 1:184-253
  children:
  - 144
  - 147
  parent: 181
- id: 149
  kind: Ident
  span: 1:261-265
  ident: !Ident
  - this
  - city
  targets:
  - 145
  parent: 151
- id: 150
  kind: Ident
  span: 1:267-273
  ident: !Ident
  - this
  - street
  targets:
  - 146
  parent: 151
- id: 151
  kind: Tuple
  span: 1:260-274
  children:
  - 149
  - 150
  parent: 192
- id: 176
  kind: RqOperator
  span: 1:296-323
  alias: total
  targets:
  - 178
  - 179
  parent: 180
- id: 178
  kind: Ident
  span: 1:296-309
  ident: !Ident
  - this
  - ii
  - unit_price
  targets:
  - 135
- id: 179
  kind: Ident
  span: 1:312-323
  ident: !Ident
  - this
  - ii
  - quantity
  targets:
  - 135
- id: 180
  kind: Tuple
  span: 1:296-323
  children:
  - 176
  parent: 181
- id: 181
  kind: 'TransformCall: Derive'
  span: 1:281-323
  children:
  - 148
  - 180
  parent: 192
- id: 182
  kind: RqOperator
  span: 1:361-388
  alias: num_orders
  targets:
  - 184
  parent: 191
- id: 184
  kind: Ident
  span: 1:376-388
  ident: !Ident
  - this
  - i
  - invoice_id
  targets:
  - 138
- id: 185
  kind: RqOperator
  span: 1:411-426
  alias: num_tracks
  targets:
  - 187
  parent: 191
- id: 187
  kind: Ident
  span: 1:415-426
  ident: !Ident
  - this
  - ii
  - quantity
  targets:
  - 135
- id: 188
  kind: RqOperator
  span: 1:450-459
  alias: total_price
  targets:
  - 190
  parent: 191
- id: 190
  kind: Ident
  span: 1:454-459
  ident: !Ident
  - this
  - total
  targets:
  - 176
- id: 191
  kind: Tuple
  span: 1:338-466
  children:
  - 182
  - 185
  - 188
  parent: 192
- id: 192
  kind: 'TransformCall: Aggregate'
  span: 1:328-466
  children:
  - 181
  - 191
  - 151
  parent: 245
- id: 195
  kind: Ident
  span: 1:476-480
  ident: !Ident
  - this
  - city
  targets:
  - 149
  parent: 196
- id: 196
  kind: Tuple
  span: 1:475-481
  children:
  - 195
- id: 220
  kind: Ident
  span: 1:493-499
  ident: !Ident
  - this
  - street
  targets:
  - 150
- id: 241
  kind: RqOperator
  span: 1:571-585
  alias: running_total_num_tracks
  targets:
  - 243
  parent: 244
- id: 243
  kind: Ident
  span: 1:575-585
  ident: !Ident
  - this
  - num_tracks
  targets:
  - 185
- id: 244
  kind: Tuple
  span: 1:543-586
  children:
  - 241
  parent: 245
- id: 245
  kind: 'TransformCall: Derive'
  span: 1:536-586
  children:
  - 192
  - 244
  parent: 254
- id: 247
  kind: Literal
- id: 251
  kind: Ident
  span: 1:601-605
  ident: !Ident
  - this
  - city
  targets:
  - 195
  parent: 254
- id: 252
  kind: Ident
  span: 1:607-613
  ident: !Ident
  - this
  - street
  targets:
  - 150
  parent: 254
- id: 254
  kind: 'TransformCall: Sort'
  span: 1:595-614
  children:
  - 245
  - 251
  - 252
  parent: 260
- id: 255
  kind: RqOperator
  span: 1:646-662
  alias: num_tracks_last_week
  targets:
  - 257
  - 258
  parent: 259
- id: 257
  kind: Literal
  span: 1:650-651
- id: 258
  kind: Ident
  span: 1:652-662
  ident: !Ident
  - this
  - num_tracks
  targets:
  - 185
- id: 259
  kind: Tuple
  span: 1:622-663
  children:
  - 255
  parent: 260
- id: 260
  kind: 'TransformCall: Derive'
  span: 1:615-663
  children:
  - 254
  - 259
  parent: 268
- id: 261
  kind: Ident
  span: 1:677-681
  ident: !Ident
  - this
  - city
  targets:
  - 195
  parent: 267
- id: 262
  kind: Ident
  span: 1:687-693
  ident: !Ident
  - this
  - street
  targets:
  - 150
  parent: 267
- id: 263
  kind: Ident
  span: 1:699-709
  ident: !Ident
  - this
  - num_orders
  targets:
  - 182
  parent: 267
- id: 264
  kind: Ident
  span: 1:715-725
  ident: !Ident
  - this
  - num_tracks
  targets:
  - 185
  parent: 267
- id: 265
  kind: Ident
  span: 1:731-755
  ident: !Ident
  - this
  - running_total_num_tracks
  targets:
  - 241
  parent: 267
- id: 266
  kind: Ident
  span: 1:761-781
  ident: !Ident
  - this
  - num_tracks_last_week
  targets:
  - 255
  parent: 267
- id: 267
  kind: Tuple
  span: 1:671-783
  children:
  - 261
  - 262
  - 263
  - 264
  - 265
  - 266
  parent: 268
- id: 268
  kind: 'TransformCall: Select'
  span: 1:664-783
  children:
  - 260
  - 267
  parent: 270
- id: 270
  kind: 'TransformCall: Take'
  span: 1:784-791
  children:
  - 268
  - 271
- id: 271
  kind: Literal
  parent: 270
ast:
  name: Project
  stmts:
  - VarDef:
      kind: Main
      name: main
      value:
        Pipeline:
          exprs:
          - FuncCall:
              name:
                Ident:
                - from
                span: 1:131-135
              args:
              - Ident:
                - invoices
                span: 1:138-146
                alias: i
            span: 1:131-146
          - FuncCall:
              name:
                Ident:
                - join
                span: 1:147-151
              args:
              - Ident:
                - invoice_items
                span: 1:155-168
                alias: ii
              - Unary:
                  op: EqSelf
                  expr:
                    Ident:
                    - invoice_id
                    span: 1:172-182
                span: 1:170-182
            span: 1:147-183
          - FuncCall:
              name:
                Ident:
                - derive
                span: 1:184-190
              args:
              - Tuple:
                - Ident:
                  - i
                  - billing_city
                  span: 1:204-218
                  alias: city
                - Ident:
                  - i
                  - billing_address
                  span: 1:233-250
                  alias: street
                span: 1:191-253
            span: 1:184-253
          - FuncCall:
              name:
                Ident:
                - group
                span: 1:254-259
              args:
              - Tuple:
                - Ident:
                  - city
                  span: 1:261-265
                - Ident:
                  - street
                  span: 1:267-273
                span: 1:260-274
              - Pipeline:
                  exprs:
                  - FuncCall:
                      name:
                        Ident:
                        - derive
                        span: 1:281-287
                      args:
                      - Binary:
                          left:
                            Ident:
                            - ii
                            - unit_price
                            span: 1:296-309
                          op: Mul
                          right:
                            Ident:
                            - ii
                            - quantity
                            span: 1:312-323
                        span: 1:296-323
                        alias: total
                    span: 1:281-323
                  - FuncCall:
                      name:
                        Ident:
                        - aggregate
                        span: 1:328-337
                      args:
                      - Tuple:
                        - FuncCall:
                            name:
                              Ident:
                              - count_distinct
                              span: 1:361-375
                            args:
                            - Ident:
                              - i
                              - invoice_id
                              span: 1:376-388
                          span: 1:361-388
                          alias: num_orders
                        - FuncCall:
                            name:
                              Ident:
                              - sum
                              span: 1:411-414
                            args:
                            - Ident:
                              - ii
                              - quantity
                              span: 1:415-426
                          span: 1:411-426
                          alias: num_tracks
                        - FuncCall:
                            name:
                              Ident:
                              - sum
                              span: 1:450-453
                            args:
                            - Ident:
                              - total
                              span: 1:454-459
                          span: 1:450-459
                          alias: total_price
                        span: 1:338-466
                    span: 1:328-466
                span: 1:281-466
            span: 1:254-468
          - FuncCall:
              name:
                Ident:
                - group
                span: 1:469-474
              args:
              - Tuple:
                - Ident:
                  - city
                  span: 1:476-480
                span: 1:475-481
              - Pipeline:
                  exprs:
                  - FuncCall:
                      name:
                        Ident:
                        - sort
                        span: 1:488-492
                      args:
                      - Ident:
                        - street
                        span: 1:493-499
                    span: 1:488-499
                  - FuncCall:
                      name:
                        Ident:
                        - window
                        span: 1:504-510
                      args:
                      - FuncCall:
                          name:
                            Ident:
                            - derive
                            span: 1:536-542
                          args:
                          - Tuple:
                            - FuncCall:
                                name:
                                  Ident:
                                  - sum
                                  span: 1:571-574
                                args:
                                - Ident:
                                  - num_tracks
                                  span: 1:575-585
                              span: 1:571-585
                              alias: running_total_num_tracks
                            span: 1:543-586
                        span: 1:536-586
                      named_args:
                        expanding:
                          Literal:
                            Boolean: true
                          span: 1:521-525
                    span: 1:504-592
                span: 1:488-592
            span: 1:469-594
          - FuncCall:
              name:
                Ident:
                - sort
                span: 1:595-599
              args:
              - Tuple:
                - Ident:
                  - city
                  span: 1:601-605
                - Ident:
                  - street
                  span: 1:607-613
                span: 1:600-614
            span: 1:595-614
          - FuncCall:
              name:
                Ident:
                - derive
                span: 1:615-621
              args:
              - Tuple:
                - FuncCall:
                    name:
                      Ident:
                      - lag
                      span: 1:646-649
                    args:
                    - Literal:
                        Integer: 7
                      span: 1:650-651
                    - Ident:
                      - num_tracks
                      span: 1:652-662
                  span: 1:646-662
                  alias: num_tracks_last_week
                span: 1:622-663
            span: 1:615-663
          - FuncCall:
              name:
                Ident:
                - select
                span: 1:664-670
              args:
              - Tuple:
                - Ident:
                  - city
                  span: 1:677-681
                - Ident:
                  - street
                  span: 1:687-693
                - Ident:
                  - num_orders
                  span: 1:699-709
                - Ident:
                  - num_tracks
                  span: 1:715-725
                - Ident:
                  - running_total_num_tracks
                  span: 1:731-755
                - Ident:
                  - num_tracks_last_week
                  span: 1:761-781
                span: 1:671-783
            span: 1:664-783
          - FuncCall:
              name:
                Ident:
                - take
                span: 1:784-788
              args:
              - Literal:
                  Integer: 20
                span: 1:789-791
            span: 1:784-791
        span: 1:131-791
    span: 1:130-791
    doc_comment: ' Calculate a number of metrics about the sales of tracks in each city.'
