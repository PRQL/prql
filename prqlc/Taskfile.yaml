version: "3"

includes:
  bindings-python:
    taskfile: ./bindings/prqlc-python
    dir: ./bindings/prqlc-python

vars:
  packages_core: -p prqlc-parser -p prqlc
  packages_addon: -p prqlc-macros -p compile-files
  packages_bindings: -p prql -p prql-java -p prqlc-js -p prqlc-c -p prqlc-python

tasks:
  fmt:
    desc: Format prqlc code (run before committing).
    cmds:
      - cmd: |
          # remove trailing whitespace
          rg '\s+$' --files-with-matches --glob '!*.{rs,snap}' . \
          | xargs -I _ sh -c "echo Removing trailing whitespace from _ && sd '[\t ]+$' '' _"

      - cmd: |
          # rustfmt
          cargo fmt {{.packages_core}} {{.packages_addon}} {{.packages_bindings}}

      - cmd: |
          # no dbg
          rg 'dbg!' --glob '*.rs' . --no-heading
        ignore_error: true

      - cmd: |
          prettier --write . \
          --config=../.prettierrc.yaml \
          --ignore-path=../.prettierignore \
          --ignore-unknown \
          --log-level=warn

  test:
    desc: Fast inner-loop test, accepting snapshots (run during development).
    env:
      NEXTEST_STATUS_LEVEL: fail
      NEXTEST_FINAL_STATUS_LEVEL: slow
      NEXTEST_HIDE_PROGRESS_BAR: "true"
    cmds:
      - cargo insta test --accept {{.packages_core}} --test-runner=nextest
      - cargo clippy --fix --allow-dirty --allow-staged {{.packages_core}}

  test-full:
    desc: Comprehensive prqlc test with coverage, accepting snapshots.
    env:
      NEXTEST_STATUS_LEVEL: fail
      NEXTEST_FINAL_STATUS_LEVEL: slow
      NEXTEST_HIDE_PROGRESS_BAR: "true"
    cmds:
      - cargo insta test --accept --features=default,test-dbs
        --test-runner=nextest --unreferenced=auto {{.packages_core}}
        {{.packages_addon}} {{.packages_bindings}}
      - cargo llvm-cov --lcov --output-path lcov.info
        --features=default,test-dbs nextest {{.packages_core}}
        {{.packages_addon}} {{.packages_bindings}}

  lint:
    desc: Run all lints (run before committing).
    cmds:
      - pre-commit run --all-files
      - cargo clippy --all-targets --all-features

  pull-request:
    desc: Complete PR checks (combines fmt + test-full + lint).
    cmds:
      - task: fmt
      - task: test-full
      - task: lint
