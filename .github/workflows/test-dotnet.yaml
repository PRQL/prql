name: test-dotnet

on:
  workflow_call:
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-2022
    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4
      - name: ğŸ— Build prqlc-clib
        run: cargo build --package prqlc-clib --release 
      - name: ğŸ”¢ Set version
        run: |
            $raw = cargo metadata --format-version=1 --no-deps 
            Write-Host "version: $raw"
            $version = $raw | jq --raw-output '.packages[0] | .version'
            echo "version=$version" >> $env:GITHUB_ENV
      - name: ğŸœ Debug CI/CD (version + target/release)
        shell: pwsh
        run: |
            Write-Host "Version: $env:version"
            Get-ChildItem ./target/release/
      - name: ğŸ”§ Setup dotnet
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: |
              6
              7
      - name: ğŸ› ï¸ Build
        working-directory: prqlc/bindings/dotnet
        shell: cmd
        run: dotnet build prql-net.sln -p:version="%version%" -c Release /p:ContinuousIntegrationBuild=true --nologo
      - name: ğŸ§ª Test
        working-directory: prqlc/bindings/dotnet
        shell: cmd
        run: dotnet test PrqlCompiler.tests\PrqlCompiler.Tests.csproj -c release --runtime win-x64 --logger GitHubActions /p:CI=true --nologo
      - name: ğŸ“¦ Package
        working-directory: prqlc/bindings/dotnet
        shell: cmd
        run: dotnet pack PrqlCompiler -p:version="$version" -c Release --include-symbols /p:CI=true --no-build --nologo
      # - name: ğŸšš Publish
      #   working-directory: prqlc/bindings/dotnet
      #   run: |
      #     dotnet nuget push PrqlCompiler/bin/Release/*.nupkg -k $NUGET_AUTH_TOKEN -s https://api.nuget.org/v3/index.json
      #   env:
      #     NUGET_AUTH_TOKEN: ${{ secrets.NUGET_TOKEN }}