---
source: src/materializer.rs
expression: materialize(ast)?
---
Query:
  items:
    - Pipeline:
        - From:
            name: prices
            alias: ~
        - Derive:
            - alias: return_total
              expr:
                SString:
                  - String: "IF(is_valid_price, "
                  - Expr:
                      Expr:
                        - Ident: prices_adj
                        - Raw: /
                        - SString:
                            - String: lag_day_todo(
                            - Expr:
                                Ident: prices_adj
                            - String: )
                        - Raw: "-"
                        - Raw: "1"
                        - Raw: +
                        - Ident: dividend_return
                  - String: ", NULL)"
            - alias: return_usd
              expr:
                SString:
                  - String: "IF(is_valid_price, "
                  - Expr:
                      Expr:
                        - Ident: prices_usd
                        - Raw: /
                        - SString:
                            - String: lag_day_todo(
                            - Expr:
                                Ident: prices_usd
                            - String: )
                        - Raw: "-"
                        - Raw: "1"
                        - Raw: +
                        - Ident: dividend_return
                  - String: ", NULL)"
            - alias: return_excess
              expr:
                Expr:
                  - Expr:
                      - SString:
                          - String: "IF(is_valid_price, "
                          - Expr:
                              Expr:
                                - Ident: prices_adj
                                - Raw: /
                                - SString:
                                    - String: lag_day_todo(
                                    - Expr:
                                        Ident: prices_adj
                                    - String: )
                                - Raw: "-"
                                - Raw: "1"
                                - Raw: +
                                - Ident: dividend_return
                          - String: ", NULL)"
                      - Raw: "-"
                      - Ident: interest_rate
                  - Raw: /
                  - Raw: "252"
            - alias: return_usd_excess
              expr:
                Expr:
                  - Expr:
                      - SString:
                          - String: "IF(is_valid_price, "
                          - Expr:
                              Expr:
                                - Ident: prices_usd
                                - Raw: /
                                - SString:
                                    - String: lag_day_todo(
                                    - Expr:
                                        Ident: prices_usd
                                    - String: )
                                - Raw: "-"
                                - Raw: "1"
                                - Raw: +
                                - Ident: dividend_return
                          - String: ", NULL)"
                      - Raw: "-"
                      - Ident: interest_rate
                  - Raw: /
                  - Raw: "252"
        - Select:
            - alias: ~
              expr:
                Ident: date
            - alias: ~
              expr:
                Ident: sec_id
            - alias: ~
              expr:
                SString:
                  - String: "IF(is_valid_price, "
                  - Expr:
                      Expr:
                        - Ident: prices_adj
                        - Raw: /
                        - SString:
                            - String: lag_day_todo(
                            - Expr:
                                Ident: prices_adj
                            - String: )
                        - Raw: "-"
                        - Raw: "1"
                        - Raw: +
                        - Ident: dividend_return
                  - String: ", NULL)"
            - alias: ~
              expr:
                SString:
                  - String: "IF(is_valid_price, "
                  - Expr:
                      Expr:
                        - Ident: prices_usd
                        - Raw: /
                        - SString:
                            - String: lag_day_todo(
                            - Expr:
                                Ident: prices_usd
                            - String: )
                        - Raw: "-"
                        - Raw: "1"
                        - Raw: +
                        - Ident: dividend_return
                  - String: ", NULL)"
            - alias: ~
              expr:
                Expr:
                  - Expr:
                      - SString:
                          - String: "IF(is_valid_price, "
                          - Expr:
                              Expr:
                                - Ident: prices_adj
                                - Raw: /
                                - SString:
                                    - String: lag_day_todo(
                                    - Expr:
                                        Ident: prices_adj
                                    - String: )
                                - Raw: "-"
                                - Raw: "1"
                                - Raw: +
                                - Ident: dividend_return
                          - String: ", NULL)"
                      - Raw: "-"
                      - Ident: interest_rate
                  - Raw: /
                  - Raw: "252"
            - alias: ~
              expr:
                Expr:
                  - Expr:
                      - SString:
                          - String: "IF(is_valid_price, "
                          - Expr:
                              Expr:
                                - Ident: prices_usd
                                - Raw: /
                                - SString:
                                    - String: lag_day_todo(
                                    - Expr:
                                        Ident: prices_usd
                                    - String: )
                                - Raw: "-"
                                - Raw: "1"
                                - Raw: +
                                - Ident: dividend_return
                          - String: ", NULL)"
                      - Raw: "-"
                      - Ident: interest_rate
                  - Raw: /
                  - Raw: "252"

