---
source: prql/src/materializer.rs
expression: materialize(ast)?
---
Query:
  items:
    - Pipeline:
        - From:
            name: employees
            alias: ~
        - Filter:
            - Expr:
                - Ident: country
                - Raw: "="
                - String: USA
        - Derive:
            - alias: gross_salary
              expr:
                Expr:
                  - Ident: salary
                  - Raw: +
                  - Ident: payroll_tax
            - alias: gross_cost
              expr:
                Expr:
                  - Expr:
                      - Ident: salary
                      - Raw: +
                      - Ident: payroll_tax
                  - Raw: +
                  - Ident: benefits_cost
        - Filter:
            - Expr:
                - Expr:
                    - Expr:
                        - Ident: salary
                        - Raw: +
                        - Ident: payroll_tax
                    - Raw: +
                    - Ident: benefits_cost
                - Raw: ">"
                - Raw: "0"
        - Aggregate:
            by:
              - Ident: title
              - Ident: country
            select:
              - alias: ~
                expr:
                  SString:
                    - String: AVG(
                    - Expr:
                        Ident: salary
                    - String: )
              - alias: ~
                expr:
                  SString:
                    - String: SUM(
                    - Expr:
                        Ident: salary
                    - String: )
              - alias: ~
                expr:
                  SString:
                    - String: AVG(
                    - Expr:
                        Expr:
                          - Ident: salary
                          - Raw: +
                          - Ident: payroll_tax
                    - String: )
              - alias: ~
                expr:
                  SString:
                    - String: SUM(
                    - Expr:
                        Expr:
                          - Ident: salary
                          - Raw: +
                          - Ident: payroll_tax
                    - String: )
              - alias: ~
                expr:
                  SString:
                    - String: AVG(
                    - Expr:
                        Expr:
                          - Expr:
                              - Ident: salary
                              - Raw: +
                              - Ident: payroll_tax
                          - Raw: +
                          - Ident: benefits_cost
                    - String: )
              - alias: sum_gross_cost
                expr:
                  SString:
                    - String: SUM(
                    - Expr:
                        Expr:
                          - Expr:
                              - Ident: salary
                              - Raw: +
                              - Ident: payroll_tax
                          - Raw: +
                          - Ident: benefits_cost
                    - String: )
              - alias: ct
                expr:
                  SString:
                    - String: COUNT(*)
        - Sort:
            - Ident: sum_gross_cost
        - Filter:
            - Expr:
                - Ident: sum_gross_cost
                - Raw: ">"
                - Raw: "200"
        - Take: 20

